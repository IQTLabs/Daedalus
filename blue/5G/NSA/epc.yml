# using version 2 for the gateway option with ipam
version: '2'

volumes:
 mongodb_data:

networks:
  cpn:
    external:
      name: cpn

services:
  mongodb:
    image: mongo:latest
    container_name: "mongodb"
    volumes:
      - mongodb_data:/data/db
    environment:
      - 'MONGO_INITDB_ROOT_USERNAME=${DB_USER}'
      - 'MONGO_INITDB_ROOT_PASSWORD=${DB_PASS}'
    hostname: mongodb
    networks:
      cpn:
        ipv4_address: 192.168.26.5
    labels:
      - "dovesnap.faucet.mirror=true"
  mongodbloader:
    image: mongo:latest
    depends_on:
      - webui
    environment:
      - DB_HOST=mongodb
      - 'DB_USER=${DB_USER}'
      - 'DB_PASS=${DB_PASS}'
    volumes:
      - "../configs/imsis.json:/tmp/imsis.json:z"
      - "../open5gs/scripts/run_db.sh:/scripts/run_db.sh:z"
    entrypoint:
      - /bin/sh
      - /scripts/run_db.sh
    networks:
      cpn:
        ipv4_address: 192.168.26.19
    labels:
      - "dovesnap.faucet.mirror=true"
  webui:
    image: open5gs:latest
    depends_on:
      - mongodb
    environment:
      - 'DB_URI=mongodb://${DB_USER}:${DB_PASS}@mongodb/open5gs?authSource=admin'
      - DB_HOST=mongodb
    container_name: webui
    hostname: webui
    ports:
      - "3000:3000"
    command:
      - "/scripts/run_webui.sh"
    networks:
      cpn:
        ipv4_address: 192.168.26.6
    labels:
      - "dovesnap.faucet.mirror=true"
  hss:
    image: open5gs:latest
    depends_on:
      - mongodb
    container_name: hss
    hostname: hss
    environment:
      - DB_HOST=mongodb
      - 'DB_USER=${DB_USER}'
      - 'DB_PASS=${DB_PASS}'
    command:
      - "/scripts/run_hss.sh"
    volumes:
      - "../configs:/usr/local/etc:z"
    networks:
      cpn:
        ipv4_address: 192.168.26.10
    restart: always
    labels:
      - "dovesnap.faucet.mirror=true"
  pcrf:
    image: open5gs:latest
    depends_on:
      - mongodb
      - hss
    container_name: pcrf
    hostname: pcrf
    environment:
      - DB_HOST=mongodb
      - 'DB_USER=${DB_USER}'
      - 'DB_PASS=${DB_PASS}'
    command:
      - "/scripts/run_pcrf.sh"
    volumes:
      - "../configs:/usr/local/etc:z"
    networks:
      cpn:
        ipv4_address: 192.168.26.50
    labels:
      - "dovesnap.faucet.mirror=true"
  mme:
    image: open5gs:latest
    depends_on:
      - hss
    container_name: mme
    hostname: mme
    command:
      - "/scripts/run_mme.sh"
    volumes:
      - "../configs:/usr/local/etc:z"
    networks:
      cpn:
        ipv4_address: 192.168.26.20
    labels:
      - "dovesnap.faucet.mirror=true"
  smf:
    image: open5gs:latest
    container_name: smf
    hostname: smf
    command:
      - "/scripts/run_smf.sh"
    volumes:
      - "../configs:/usr/local/etc:z"
    networks:
      cpn:
        ipv4_address: 192.168.26.40
    labels:
      - "dovesnap.faucet.mirror=true"
  sgwc:
    image: open5gs:latest
    container_name: sgwc
    hostname: sgwc
    command:
      - "/scripts/run_sgwc.sh"
    volumes:
      - "../configs:/usr/local/etc:z"
    networks:
      cpn:
        ipv4_address: 192.168.26.30
    labels:
      - "dovesnap.faucet.mirror=true"
